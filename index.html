<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width"/>
    <title>atproto PDS & account debugger</title>
    <meta name="description" content="Quick diagnostics for PDS hosts, handles, relay connections, handles, DIDs, ..." />

    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <script type="module">
      import {
        Client,
        ClientResponseError,
        ok,
        simpleFetchHandler,
      } from 'https://esm.sh/@atcute/client@4.1.1';
      import {
        DohJsonHandleResolver,
        WellKnownHandleResolver,
      } from 'https://esm.sh/@atcute/identity-resolver@1.2.1';

      window.SimpleQuery = service => {
        const client = new Client({ handler: simpleFetchHandler({ service }) });
        return (...args) => ok(client.get(...args));
      };
      window.SimpleProc = service => {
        const client = new Client({ handler: simpleFetchHandler({ service }) });
        return (...args) => ok(client.post(...args));
      };
      window.isXrpcErr = e => e instanceof ClientResponseError;

      window.dnsResolver = new DohJsonHandleResolver({
        dohUrl: 'https://mozilla.cloudflare-dns.com/dns-query',
      });
      window.httpResolver = new WellKnownHandleResolver();

      window.slingshot = window.SimpleQuery('https://slingshot.microcosm.blue');
      window.relays = [
        {
          name: 'Bluesky',
          icon: 'https://web-cdn.bsky.app/static/apple-touch-icon.png',
          hostname: 'bsky.network',
          note: 'current',
          missingApis: {
            ['com.atproto.sync.getHostStatus']: 'missing API (old relay code)',
            ['com.atproto.sync.getRepoStatus']: 'missing API (old relay code)',
          },
        },
        {
          name: 'Microcosm Montreal',
          hostname: 'relay.fire.hose.cam',
        },
        {
          name: 'Microcosm France',
          hostname: 'relay3.fr.hose.cam',
        },
        {
          name: 'Upcloud',
          icon: 'https://upcloud.com/media/android-chrome-512x512-2-150x150.png',
          hostname: 'relay.upcloud.world',
        },
        {
          name: 'Blacksky',
          icon: 'https://blacksky.community/static/favicon-32x32.png',
          hostname: 'atproto.africa',
          missingApis: {
            ['com.atproto.sync.getHostStatus']: 'API not yet deployed',
            ['com.atproto.sync.getRepoStatus']: 'API not implemented',
          },
        },
        {
          name: 'Bluesky East',
          icon: 'https://web-cdn.bsky.app/static/favicon-32x32.png',
          note: 'future',
          hostname: 'relay1.us-east.bsky.network',
        },
        {
          name: 'Bluesky West',
          icon: 'https://web-cdn.bsky.app/static/favicon-32x32.png',
          note: 'future',
          hostname: 'relay1.us-west.bsky.network',
        },
      ];
    </script>

    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('debug', () => ({
          // form input
          identifier: '',

          // state
          identifierLoading: false,
          identifierError: null,

          // stuff to check
          pds: null,
          did: null,
          handle: null,

          async goto(identifier) {
            this.identifier = identifier;
            await this.diagnose();
          },

          async diagnose() {
            this.identifierLoading = true;
            this.identifierError = null;
            this.pds = null;
            this.did = null;
            this.handle = null;
            this.identifier = this.identifier.trim();
            if (this.identifier === '') {
              // do nothing
            } else if (this.identifier.startsWith('https://')) {
              this.pds = this.identifier;
            } else {
              if (this.identifier.startsWith('at://')) {
                this.identifier = this.identifier.slice('at://'.length);
              }
              if (this.identifier.startsWith('did:')) {
                this.did = this.identifier;
                let data;
                try {
                  data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                    params: { identifier: this.identifier },
                  });
                  this.pds = data.pds;
                  this.handle = data.handle;
                } catch (e) {
                  if (window.isXrpcErr(e)) {
                    this.identifierError = e.error;
                    if (e.message) this.description += ` ${e.description}`;
                  } else {
                    this.identifierError = 'Failed to resolve identifier, see console for error.';
                    console.error(e);
                  }
                }
              } else {
                this.handle = this.identifier;
                let data;
                try {
                  data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                    params: { identifier: this.identifier },
                  });
                  this.did = data.did;
                  this.pds = data.pds;
                } catch (e) {
                  if (window.isXrpcErr(e)) {
                    this.identifierError = e.error;
                    if (e.message) this.description += ` ${e.description}`;
                  } else {
                    this.identifierError = 'Failed to resolve identifier, see console for error.';
                    console.error(e);
                  }
                }
              }
            }
            this.identifierLoading = false;
          },
        }));

        Alpine.data('pdsCheck', pds => ({
          loadingDesc: false,
          error: null,
          description: null,
          accounts: [],
          accountsComplete: false,
          version: null,

          async init() {
            await this.update(pds);
          },

          async update(pds) {
            this.loadingDesc = true;
            this.error = null;
            this.description = null;
            this.accounts = [];
            this.accountsComplete = false;
            this.version = null;

            if (!pds) {
              this.loadingDesc = false;
              return;
            }

            let query = window.SimpleQuery(pds);
            try {
              this.description = await query('com.atproto.server.describeServer');
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            let health
            try {
              health = await query('_health');
              this.version = health.version;
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            let accountsRes;
            try {
              accountsRes = await query('com.atproto.sync.listRepos', {
                params: { limit: 100 },
              });
              this.accounts = accountsRes.repos;
              this.accountsComplete == !accountsRes.cursor;
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            this.loadingDesc = false;
          },
        }));

        Alpine.data('relayCheckHost', (pds, relay) => ({
          loading: false,
          error: null,
          status: null,
          expectedErrorInfo: null,
          reqCrawlStatus: null,
          reqCrawlError: null,

          async init() {
            await this.check(pds, relay);
          },

          async check(pds, relay) {
            this.loading = true;
            this.error = null;
            this.status = null;
            this.expectedError = false;
            const query = window.SimpleQuery(`https://${relay.hostname}`);
            const hostname = pds.split('://')[1];
            let data;
            try {
              data = await query('com.atproto.sync.getHostStatus', {
                params: { hostname },
              });
              this.status = data.status;
            } catch(e) {
              if (relay.missingApis['com.atproto.sync.getHostStatus']) {
                this.error = 'Can\'t check';
                this.expectedErrorInfo = relay.missingApis['com.atproto.sync.getHostStatus'];
              } else if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to check (see console)';
                console.error(e);
              }
            }
            this.loading = false;
            this.reqCrawlStatus = null;
            this.reqCrawlError = null;
          },

          async requestCrawl(pds, relay) {
            this.reqCrawlStatus = "loading";
            const proc = window.SimpleProc(`https://${relay.hostname}`);
            const hostname = pds.split('://')[1];
            let data;
            try {
              data = await proc('com.atproto.sync.requestCrawl', {
                input: { hostname },
              });
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.reqCrawlError = e.error;
              } else {
                this.reqCrawlError = 'failed (see console)';
                console.error(e);
              }
            }
            this.reqCrawlStatus = "done";
          },
        }));

        Alpine.data('checkHandle', handle => ({
          loading: false,
          dnsDid: null,
          dnsErr: null,
          httpDid: null,
          httpErr: null,

          async init() {
            await this.updateHandle(handle);
          },
          async updateHandle(handle) {
            this.loading = true;
            this.dnsDid = null;
            this.dnsErr = null;
            this.httpDid = null;
            this.httpErr = null;
            try {
              this.dnsDid = await window.dnsResolver.resolve(handle);
            } catch (e) {
              this.dnsErr = e.name;
            }
            try {
              this.httpDid = await window.httpResolver.resolve(handle);
            } catch (e) {
              this.httpErr = e.name;
            }
            this.loading = false;
          },
        }));

        Alpine.data('didToHandle', did => ({
          loading: false,
          error: null,
          handle: null,
          async load() {
            loading = true;
            error = null;
            handle = null;
            let data;
            try {
              data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                params: { identifier: did },
              });
              this.handle = data.handle;
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'failed (see console)';
                console.error(e);
              }
            }
            loading = false;
          }
        }));

        Alpine.data('didRepoState', (did, pds) => ({
          loading: false,
          error: null,
          state: null,

          async init() {
            await this.checkRepoState(did, pds);
          },
          async checkRepoState(did, pds) {
            this.loading = true;
            this.error = null;
            this.state = null;

            if (!did || !pds) {
              this.loading = false;
              return;
            }
            const query = window.SimpleQuery(pds);
            try {
              this.state = await query('com.atproto.sync.getRepoStatus', {
                params: { did },
              });
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'failed (see console)';
                console.error(e);
              }
            }
            this.loading = false;
          },
        }));

        Alpine.data('repoSize', () => ({
          lading: false,
          error: null,
          size: null,

          async loadRepoForSize(did, pds) {
            this.loading = true;

            if (!did || !pds) {
              this.loading = false;
              return;
            }
            const query = window.SimpleQuery(pds);
            try {
              const res = await query('com.atproto.sync.getRepo', {
                params: { did },
                as: 'blob',
              });
              let bytes = res.size;
              let mbs = bytes / Math.pow(2, 20);
              this.size = mbs.toFixed(1);
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'failed (see console)';
                console.error(e);
              }
            }
            this.loading = false;
          },
        }));

        Alpine.data('relayCheckRepo', (did, relay) => ({
          loading: false,
          error: null,
          status: null,
          expectedErrorInfo: null,

          async init() {
            await this.check(did, relay);
          },

          async check(did, relay) {
            this.loading = true;
            this.error = null;
            this.status = null;
            this.expectedErrorInfo = null;

            const query = window.SimpleQuery(`https://${relay.hostname}`);
            try {
              this.status = await query('com.atproto.sync.getRepoStatus', {
                params: { did },
              });
            } catch(e) {
              if (relay.missingApis['com.atproto.sync.getRepoStatus']) {
                this.error = 'Can\'t check';
                this.expectedErrorInfo = relay.missingApis['com.atproto.sync.getRepoStatus'];
              } else if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to check (see console)';
                console.error(e);
              }
            }

            this.loading = false;
          },
        }));

        Alpine.data('pdsHistory', (did, currentPds) => ({
          loading: false,
          error: null,
          history: [],

          async init() {
            this.loading = true;
            this.error = null;
            this.history = [];
            try {
              const res = await fetch(`https://plc.directory/${did}/log/audit`);
              if (res.ok) {
                const log = await res.json();
                let prev = null;
                for (op of log) {
                  let opPds = null;
                  const services = op.operation.services;
                  if (services) {
                    const app = services.atproto_pds;
                    if (app) {
                      opPds = app.endpoint;
                    }
                  }
                  if (opPds === prev) continue;
                  prev = opPds;
                  this.history.push({
                    pds: opPds,
                    date: op.createdAt,
                  });
                }
                this.history.reverse();
                if (this.history[0]) this.history[0].current = true;
              } else {
                this.error = `${res.status}: ${await res.text()}`;
              }
            } catch (e) {
              this.error = 'failed to get history';
              console.error(e);
            }
            this.loading = false;
          },
        }));

        Alpine.data('handleHistory', (did, currentHandle) => ({
          loading: false,
          error: null,
          history: [],

          async init() {
            this.loading = true;
            this.error = null;
            this.history = [];
            try {
              const res = await fetch(`https://plc.directory/${did}/log/audit`);
              if (res.ok) {
                const log = await res.json();
                let prev = null;
                for (op of log) {
                  let opHandle = null;
                  if (op.operation.alsoKnownAs) {
                    for (aka of op.operation.alsoKnownAs) {
                      if (aka.startsWith("at://")) {
                        opHandle = aka.slice("at://".length);
                        break;
                      }
                    }
                  }
                  if (opHandle === prev) continue;
                  prev = opHandle;
                  this.history.push({
                    handle: opHandle,
                    date: op.createdAt,
                  });
                }
                this.history.reverse();
              } else {
                this.error = `${res.status}: ${await res.text()}`;
              }
            } catch (e) {
              this.error = 'failed to get history';
              console.error(e);
            }
            this.loading = false;
          },
        }));
      })
    </script>
  </head>
  <body x-data="debug">
    <div class="hero bg-base-200">
      <div class="hero-content flex-col">
        <h1>PDS Debugger</h1>

        <p class="text-sm">Work in progress!</p>
        <details class="text-xs">
          <summary>Future features</summary>
          <ul class="list-disc pl-4">
            <li>firehose & jetstream listeners</li>
          </ul>
        </details>
        <details class="text-xs">
          <summary>Limitations</summary>
          <ul class="list-disc pl-4">
            <li>The Bluesky production relay at <code>bsky.network</code> runs the old bgs implementation, and is missing many relay XRPC endpoints.</li>
            <li>The Blacksky relay at <code>atproto.africa</code> runs an independent implementation, and is also missing many relay XRPC endpoints.</li>
            <li>All diagnostics run in your browser, so servers that don't enable CORS (some PDS hosts, Upcloud's relay) will fail tests.</li>
          </ul>
        </details>

        <div class="card bg-base-100 w-full max-w-sm shrink-0 shadow-2xl">
          <div class="card-body">
            <form @submit.prevent="await diagnose()">
              <label>
                Enter an atproto handle, DID, or HTTPS PDS URL
                <input
                  class="input"
                  x-model="identifier"
                  :disabled="identifierLoading"
                  autofocus
                />
              </label>
            </form>
          </div>
        </div>

        <template x-if="identifierError">
          <p>uh oh: <span x-text="identifierError"></span></p>
        </template>

        <template x-if="pds != null">
          <div class="card bg-base-100 w-full max-w-lg shrink-0 shadow-2xl">
            <div class="card-body">
              <h2 class="card-title">
                 <span class="badge badge-secondary">PDS</span>
                 <span x-text="pds"></span>
              </h2>

              <div
                x-data="pdsCheck(pds)"
                x-init="$watch('pds', v => update(v))"
              >
                <h3 class="text-lg mt-3">
                  Server
                  <span
                    x-show="description !== null"
                    class="badge badge-sm badge-soft badge-success"
                  >online</span>
                </h3>
                <p x-show="loadingDesc">Loading&hellip;</p>
                <p x-show="error" class="text-warning" x-text="error"></p>
                <template x-if="description !== null">
                  <div>
                    <div class="overflow-x-auto">
                      <table class="table table-xs">
                        <tbody>
                          <tr>
                            <td class="text-sm">
                              Open registration:
                              <span
                                x-text="!description.inviteCodeRequired"
                              ></span>
                            </td>
                          </tr>
                          <tr>
                            <td class="text-sm">
                              Version:
                              <code
                                class="text-xs"
                                x-text="version"
                              ></code>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <h4 class="font-bold">
                      Accounts
                    </h4>
                    <div class="overflow-x-auto overflow-y-auto max-h-26">
                      <table class="table table-xs">
                        <tbody>
                          <template x-for="account in accounts">
                            <tr>
                              <td>
                                <code>
                                  <a
                                    href="#"
                                    class="link"
                                    x-text="account.did"
                                    @click.prevent="goto(account.did)"
                                  ></a>
                                </code>
                              </td>
                              <td>
                                <span
                                  x-show="account.active"
                                  class="badge badge-sm badge-soft badge-success"
                                >
                                  active
                                </span>
                                <span
                                  x-show="!account.active"
                                  x-text="account.status"
                                  class="badge badge-sm badge-soft badge-warning"
                                ></span>
                              </td>
                              <td
                                x-data="didToHandle(account.did)"
                                x-intersect:enter.once="load"
                              >
                                <span x-show="loading">Loading&hellip;</span>
                                <span x-show="error !== null" x-text="error"></span>
                                <a
                                  href="#"
                                  class="link"
                                  @click.prevent="goto(handle)"
                                  x-show="handle !== null"
                                  x-text="`@${handle}`"
                                ></a>
                              </td>
                            </tr>
                          </template>
                          <template x-if="!loadingDesc && !accountsComplete">
                            <tr>
                              <td colspan="2" class="text-xs text-warning-content">
                                (more accounts not shown)
                              </td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </template>
              </div>

              <h3 class="text-lg mt-3">Relay host status</h3>
              <div class="overflow-x-auto">
                <table class="table table-xs">
                  <tbody>
                    <template x-for="relay in window.relays">
                      <tr
                        x-data="relayCheckHost(pds, relay)"
                        x-init="$watch('pds', pds => check(pds, relay))"
                      >
                        <td class="text-sm">
                          <div class="tooltip tooltip-right" :data-tip="relay.hostname">
                            <img
                              class="inline-block h-4 w-4"
                              :src="relay.icon"
                              alt=""
                            />
                            <span x-text="relay.name"></span>
                            <span
                              x-show="!!relay.note"
                              x-text="relay.note"
                              class="badge badge-soft badge-neutral badge-xs"
                            ></span>
                          </div>
                        </td>
                        <td>
                          <template x-if="loading">
                            <em>loading&hellip;</em>
                          </template>
                          <template x-if="error">
                            <div
                              class="text-xs"
                              :class="expectedErrorInfo
                                ? 'text-info tooltip tooltip-left cursor-help'
                                : 'text-warning'"
                              :data-tip="expectedErrorInfo"
                            >
                              <span x-text="error"></span>
                              <span
                                x-show="!!expectedErrorInfo"
                                class="badge badge-soft badge-info badge-xs"
                              >i</span>
                            </div>
                          </template>
                          <template x-if="status">
                            <span
                              x-text="status"
                              class="badge badge-sm"
                              :class="status === 'active' && 'badge-soft badge-success'"
                            ></span>
                          </template>
                        </td>
                        <td>
                          <div x-show="status !== 'active' && !expectedErrorInfo">
                            <button
                              x-show="reqCrawlStatus !== 'done'"
                              class="btn btn-xs btn-ghost whitespace-nowrap"
                              :disabled="reqCrawlStatus === 'loading'"
                              @click="requestCrawl(pds, relay)"
                            >
                              request crawl
                            </button>
                            <span
                              x-show="reqCrawlError !== null"
                              x-text="reqCrawlError"
                              class="text-xs text-warning"
                            ></span>
                            <button
                              x-show="reqCrawlError === null && reqCrawlStatus === 'done'"
                              class="btn btn-xs btn-soft btn-primary whitespace-nowrap"
                              @click="check"
                            >
                              refresh
                            </button>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </template>

        <template x-if="did != null">
          <div class="card bg-base-100 w-full max-w-lg shrink-0 shadow-2xl">
            <div class="card-body">
              <h2 class="card-title">
                <span class="badge badge-secondary">DID</span>
                <code x-text="did"></code>
              </h2>
              <template x-if="pds != null">
                <div x-data="didRepoState(did, pds)">
                  <h3 class="text-lg mt-3">
                    Repo
                    <span
                      x-show="state && state.active"
                      class="badge badge-sm badge-soft badge-success"
                    >active</span>
                  </h3>
                  <div class="overflow-x-auto">
                    <table class="table table-xs">
                      <tbody>
                        <tr>
                          <td class="text-sm">
                            Rev:
                            <code x-text="state && state.rev"></code>
                          </td>
                        </tr>
                        <tr>
                          <td class="text-sm">
                            PDS:
                            <a
                              href="#"
                              class="link"
                              @click.prevent="goto(pds)"
                              x-text="pds"
                            ></a>
                          </td>
                        </tr>
                        <tr>
                          <td class="text-sm">
                            Size:
                            <span x-data="repoSize">
                              <template x-if="loading">
                                <em>loading&hellip;</em>
                              </template>
                              <template x-if="error">
                                <span class="text-xs text-warning" x-text="error"></span>
                              </template>
                              <template x-if="size">
                                <code>
                                  <span x-text="size"></span> MiB
                                </code>
                              </template>
                              <template x-if="!size && !error && !loading">
                                <button
                                  class="btn btn-xs btn-soft btn-primary"
                                  @click.prevent="loadRepoForSize(did, pds)"
                                >load</button>
                              </template>
                            </span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <h3 class="text-lg mt-3">
                    Relay repo status
                  </h3>
                  <div class="overflow-x-auto">
                    <table class="table table-xs">
                      <tbody>
                        <template x-for="relay in window.relays">
                          <tr
                            x-data="relayCheckRepo(did, relay)"
                            x-init="$watch('pds', pds => check(did, relay))"
                          >
                            <td class="text-sm">
                              <div class="tooltip tooltip-right" :data-tip="relay.hostname">
                                <img
                                  class="inline-block h-4 w-4"
                                  :src="relay.icon"
                                  alt=""
                                />
                                <span x-text="relay.name"></span>
                                <span
                                  x-show="!!relay.note"
                                  x-text="relay.note"
                                  class="badge badge-neutral badge-soft badge-xs"
                                ></span>
                              </div>
                            </td>
                            <template x-if="loading">
                              <td>
                                <em>loading&hellip;</em>
                              </td>
                            </template>
                            <template x-if="error">
                              <td>
                                <div
                                  class="text-xs"
                                  :class="expectedErrorInfo
                                    ? 'text-info tooltip tooltip-left cursor-help'
                                    : 'text-warning'"
                                  :data-tip="expectedErrorInfo"
                                >
                                  <span x-text="error"></span>
                                  <span
                                    x-show="!!expectedErrorInfo"
                                    class="badge badge-soft badge-info badge-xs"
                                  >i</span>
                                </div>
                              </td>
                            </template>
                            <template x-if="status">
                              <td>
                                <span
                                  x-show="status.active"
                                  class="badge badge-sm badge-soft badge-success"
                                >
                                  active
                                </span>
                                <span
                                  x-show="!status.active"
                                  x-text="status.status"
                                  class="badge badge-sm badge-soft badge-warning"
                                ></span>
                              </td>
                            </template>
                            <template x-if="status">
                              <td>
                                <code
                                  x-text="status.rev"
                                  class="badge badge-sm badge-soft"
                                  :class="status && state && (status.rev >= state.rev) ? 'badge-success' : 'badge-warning'"
                                ></code>
                              </td>
                            </template>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>

                  <template x-if="did.startsWith('did:plc:')">
                    <div x-data="pdsHistory(did, pds)">
                      <h3 class="text-lg mt-3">
                        PLC PDS history
                      </h3>
                      <div class="overflow-x-auto">
                        <table class="table table-xs">
                          <tbody>
                            <template x-if="loading">
                              <tr>
                                <td>Loading&hellip;</td>
                              </tr>
                            </template>
                            <template x-if="error">
                              <tr>
                                <td>Error: <span x-text="error"></span></td>
                              </tr>
                            </template>
                            <template x-if="!loading && !error && history.length === 0">
                              <tr>
                                <td class="text-sm">
                                  <em>no previous PDS</em>
                                </td>
                              </tr>
                            </template>
                            <template x-for="event in history">
                              <tr x-data="didRepoState(did, event.pds)">
                                <td>
                                  <code x-text="event.date.split('T')[0]"></code>
                                </td>
                                <td>
                                  <a
                                    href="#"
                                    class="link"
                                    @click.prevent="goto(event.pds)"
                                    x-text="event.pds"
                                  ></a>
                                </td>
                                <template x-if="event.current">
                                  <td>
                                    <span
                                      x-show="state && !state.active"
                                      x-text="state && state.status"
                                      class="badge badge-sm badge-soft badge-warning"
                                    ></span>
                                    <span
                                      x-show="state && state.active"
                                      class="badge badge-sm badge-soft badge-success"
                                    >current</span>
                                  </td>
                                </template>
                                <template x-if="!event.current">
                                  <td>
                                    <span
                                      x-show="state && !state.active"
                                      x-text="state && state.status"
                                      class="badge badge-sm badge-soft badge-success"
                                    ></span>
                                    <span
                                      x-show="state && state.active"
                                      class="badge badge-sm badge-soft badge-warning"
                                    >active</span>
                                  </td>
                                </template>
                              </tr>
                            </template>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </template>

        <template x-if="handle !== null">
          <div class="card bg-base-100 w-full max-w-lg shrink-0 shadow-2xl">
            <div
              x-data="checkHandle(handle)"
              x-init="$watch('handle', h => updateHandle(h))"
              class="card-body"
            >
              <h2 class="card-title">
                <span class="badge badge-secondary">Handle</span>
                <span x-text="handle"></span>
              </h2>

              <h3 class="text-lg mt-3">
                Resolution
              </h3>
              <p x-show="loading" class="text-i">Loading&hellip;</p>
              <div x-show="!loading" class="overflow-x-auto">
                <table class="table table-xs">
                  <tbody>
                    <tr>
                      <td class="text-sm">DNS</td>
                      <td class="text-sm">
                        <code x-text="dnsDid"></code>
                      </td>
                      <td>
                        <div
                          class="badge badge-sm badge-soft badge-neutral"
                          x-show="dnsErr !== null"
                          x-text="dnsErr"
                        ></div>
                      </td>
                    </tr>
                    <tr>
                      <td class="text-sm">Http</td>
                      <td class="text-sm">
                        <code x-text="httpDid"></code>
                      </td>
                      <td>
                        <div
                          class="badge badge-sm badge-soft badge-neutral"
                          x-show="httpErr !== null"
                          x-text="httpErr"
                        ></div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <template x-if="did !== null && did.startsWith('did:plc:')">

                <div x-data="handleHistory(did, handle)">
                  <h3 class="text-lg mt-3">
                    PLC handle history
                  </h3>
                  <div class="overflow-x-auto">
                    <table class="table table-xs">
                      <tbody>
                        <template x-if="loading">
                          <tr>
                            <td>Loading&hellip;</td>
                          </tr>
                        </template>
                        <template x-if="error">
                          <tr>
                            <td>Error: <span x-text="error"></span></td>
                          </tr>
                        </template>
                        <template x-if="!loading && !error && history.length === 0">
                          <tr>
                            <td class="text-sm">
                              <em>no previous handle</em>
                            </td>
                          </tr>
                        </template>
                        <template x-for="event in history">
                          <tr>
                            <td>
                              <code x-text="event.date.split('T')[0]"></code>
                            </td>
                            <td>
                              <a
                                href="#"
                                class="link"
                                @click.prevent="goto(event.handle)"
                                x-text="event.handle"
                              ></a>
                            </td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>

              </template>
            </div>
          </div>
        </template>
      </div>
    </div>
  </body>
</html>
