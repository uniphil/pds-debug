<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width"/>
    <title>atproto PDS & account debugger</title>
    <meta name="description" content="Quick diagnostics for PDS hosts, handles, relay connections, handles, DIDs, ..." />

    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <script type="module">
      import {
        Client,
        ClientResponseError,
        ok,
        simpleFetchHandler,
      } from 'https://esm.sh/@atcute/client@4.1.1';
      import {
        DohJsonHandleResolver,
        WellKnownHandleResolver,
      } from 'https://esm.sh/@atcute/identity-resolver@1.2.1';

      window.SimpleQuery = service => {
        const client = new Client({ handler: simpleFetchHandler({ service }) });
        return (...args) => ok(client.get(...args));
      };
      window.SimpleProc = service => {
        const client = new Client({ handler: simpleFetchHandler({ service }) });
        return (...args) => ok(client.post(...args));
      };
      window.isXrpcErr = e => e instanceof ClientResponseError;

      window.isBeforeNow = iso => new Date(iso) < new Date();

      window.dnsResolver = new DohJsonHandleResolver({
        dohUrl: 'https://mozilla.cloudflare-dns.com/dns-query',
      });
      window.httpResolver = new WellKnownHandleResolver();

      window.slingshot = window.SimpleQuery('https://slingshot.microcosm.blue');
      window.relays = [
        {
          name: 'Bluesky',
          icon: './icons/bsky-favicon.png',
          hostname: 'bsky.network',
          note: 'current',
          missingApis: {
            ['com.atproto.sync.getHostStatus']: 'missing API (old relay code)',
            ['com.atproto.sync.getRepoStatus']: 'missing API (old relay code)',
          },
        },
        {
          name: 'Microcosm Montreal',
          icon: './icons/microcosm-favicon.png',
          hostname: 'relay.fire.hose.cam',
        },
        {
          name: 'Microcosm France',
          icon: './icons/microcosm-favicon.png',
          hostname: 'relay3.fr.hose.cam',
        },
        {
          name: 'Upcloud',
          icon: 'https://upcloud.com/media/android-chrome-512x512-2-150x150.png',
          hostname: 'relay.upcloud.world',
        },
        {
          name: 'Blacksky',
          icon: 'https://blacksky.community/static/favicon-32x32.png',
          hostname: 'atproto.africa',
          missingApis: {
            ['com.atproto.sync.getHostStatus']: 'API not yet deployed',
            ['com.atproto.sync.getRepoStatus']: 'API not implemented',
          },
        },
        {
          name: 'Bluesky East',
          icon: './icons/bsky-favicon.png',
          note: 'future',
          hostname: 'relay1.us-east.bsky.network',
        },
        {
          name: 'Bluesky West',
          icon: './icons/bsky-favicon.png',
          note: 'future',
          hostname: 'relay1.us-west.bsky.network',
        },
      ];
    </script>

    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('debug', () => ({
          // form input
          identifier: '',

          // state
          identifierLoading: false,
          identifierError: null,

          // stuff to check
          pds: null,
          did: null,
          handle: null,

          async goto(identifier) {
            this.identifier = identifier;
            await this.diagnose();
          },

          async diagnose() {
            this.identifierLoading = true;
            this.identifierError = null;
            this.pds = null;
            this.did = null;
            this.handle = null;
            this.identifier = this.identifier.trim();
            if (this.identifier === '') {
              // do nothing
            } else if (this.identifier.startsWith('https://')) {
              this.pds = this.identifier;
            } else {
              if (this.identifier.startsWith('at://')) {
                this.identifier = this.identifier.slice('at://'.length);
              }
              if (this.identifier.startsWith('did:')) {
                this.did = this.identifier;
                let data;
                try {
                  data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                    params: { identifier: this.identifier },
                  });
                  this.pds = data.pds;
                  this.handle = data.handle;
                } catch (e) {
                  if (window.isXrpcErr(e)) {
                    this.identifierError = e.error;
                    if (e.message) this.description += ` ${e.description}`;
                  } else {
                    this.identifierError = 'Failed to resolve identifier, see console for error.';
                    console.error(e);
                  }
                }
              } else {
                this.handle = this.identifier.toLowerCase();
                let data;
                try {
                  data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                    params: { identifier: this.identifier.toLowerCase() },
                  });
                  this.did = data.did;
                  this.pds = data.pds;
                } catch (e) {
                  if (window.isXrpcErr(e)) {
                    this.identifierError = e.error;
                    if (e.message) this.description += ` ${e.description}`;
                  } else {
                    this.identifierError = 'Failed to resolve identifier, see console for error.';
                    console.error(e);
                  }
                }
              }
            }
            this.identifierLoading = false;
          },
        }));

        Alpine.data('pdsCheck', pds => ({
          loadingDesc: false,
          error: null,
          description: null,
          accounts: [],
          accountsComplete: false,
          version: null,

          async init() {
            await this.update(pds);
          },

          async update(pds) {
            this.loadingDesc = true;
            this.error = null;
            this.description = null;
            this.accounts = [];
            this.accountsComplete = false;
            this.version = null;

            if (!pds) {
              this.loadingDesc = false;
              return;
            }

            let query = window.SimpleQuery(pds);
            try {
              this.description = await query('com.atproto.server.describeServer');
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            let health
            try {
              health = await query('_health');
              this.version = health.version;
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            let accountsRes;
            try {
              accountsRes = await query('com.atproto.sync.listRepos', {
                params: { limit: 100 },
              });
              this.accounts = accountsRes.repos;

              // weird thing with the ref pds: it *always* has a cursor on the first page
              if (accountsRes.cursor) {
                // so grab a second page just to see if there really is a second page
                try {
                  const secondPage = await query('com.atproto.sync.listRepos', {
                    params: { limit: 1, cursor: accountsRes.cursor },
                  });
                  this.accountsComplete = !secondPage.cursor || secondPage.repos.length == 0;
                } catch (e) {
                  // we're in a niche spot. ignore errors and look at the original (faulty) cursor
                  this.accountsComplete = !accountsRes.cursor; // ðŸ¤·â€â™€ï¸
                }
              } else {
                this.accountsComplete = true;
              }

            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            this.loadingDesc = false;
          },
        }));

        Alpine.data('relayCheckHost', (pds, relay) => ({
          loading: false,
          error: null,
          status: null,
          expectedErrorInfo: null,
          reqCrawlStatus: null,
          reqCrawlError: null,

          async init() {
            await this.check(pds, relay);
          },

          async check(pds, relay) {
            this.loading = true;
            this.error = null;
            this.status = null;
            this.expectedError = false;
            const query = window.SimpleQuery(`https://${relay.hostname}`);
            const hostname = pds.split('://')[1];
            let data;
            try {
              data = await query('com.atproto.sync.getHostStatus', {
                params: { hostname },
              });
              this.status = data.status;
            } catch(e) {
              if (relay.missingApis?.['com.atproto.sync.getHostStatus']) {
                this.error = 'Can\'t check';
                this.expectedErrorInfo = relay.missingApis?.['com.atproto.sync.getHostStatus'];
              } else if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to check (see console)';
                console.error(e);
              }
            }
            this.loading = false;
            this.reqCrawlStatus = null;
            this.reqCrawlError = null;
          },

          async requestCrawl(pds, relay) {
            this.reqCrawlStatus = "loading";
            const proc = window.SimpleProc(`https://${relay.hostname}`);
            const hostname = pds.split('://')[1];
            let data;
            try {
              data = await proc('com.atproto.sync.requestCrawl', {
                input: { hostname },
              });
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.reqCrawlError = e.error;
              } else {
                this.reqCrawlError = 'failed (see console)';
                console.error(e);
              }
            }
            this.reqCrawlStatus = "done";
          },
        }));

        Alpine.data('checkHandle', handle => ({
          loading: false,
          dnsDid: null,
          dnsErr: null,
          httpDid: null,
          httpErr: null,

          async init() {
            await this.updateHandle(handle);
          },
          async updateHandle(handle) {
            this.loading = true;
            this.dnsDid = null;
            this.dnsErr = null;
            this.httpDid = null;
            this.httpErr = null;
            try {
              this.dnsDid = await window.dnsResolver.resolve(handle);
            } catch (e) {
              this.dnsErr = e.name;
            }
            try {
              this.httpDid = await window.httpResolver.resolve(handle);
            } catch (e) {
              this.httpErr = e.name;
            }
            this.loading = false;
          },
        }));

        Alpine.data('didToHandle', did => ({
          loading: false,
          error: null,
          handle: null,
          async load() {
            loading = true;
            error = null;
            handle = null;
            let data;
            try {
              data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                params: { identifier: did },
              });
              this.handle = data.handle;
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'failed (see console)';
                console.error(e);
              }
            }
            loading = false;
          }
        }));

        Alpine.data('didRepoState', (did, pds) => ({
          loading: false,
          error: null,
          state: null,

          async init() {
            await this.checkRepoState(did, pds);
          },
          async checkRepoState(did, pds) {
            this.loading = true;
            this.error = null;
            this.state = null;

            if (!did || !pds) {
              this.loading = false;
              return;
            }
            const query = window.SimpleQuery(pds);
            try {
              this.state = await query('com.atproto.sync.getRepoStatus', {
                params: { did },
              });
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'failed (see console)';
                console.error(e);
              }
            }
            this.loading = false;
          },
        }));

        Alpine.data('repoSize', () => ({
          lading: false,
          error: null,
          size: null,

          async loadRepoForSize(did, pds) {
            this.loading = true;

            if (!did || !pds) {
              this.loading = false;
              return;
            }
            const query = window.SimpleQuery(pds);
            try {
              const res = await query('com.atproto.sync.getRepo', {
                params: { did },
                as: 'blob',
              });
              let bytes = res.size;
              let mbs = bytes / Math.pow(2, 20);
              this.size = mbs.toFixed(1);
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'failed (see console)';
                console.error(e);
              }
            }
            this.loading = false;
          },
        }));

        Alpine.data('relayCheckRepo', (did, relay) => ({
          loading: false,
          error: null,
          status: null,
          expectedErrorInfo: null,

          async init() {
            await this.check(did, relay);
          },

          async check(did, relay) {
            this.loading = true;
            this.error = null;
            this.status = null;
            this.expectedErrorInfo = null;

            const query = window.SimpleQuery(`https://${relay.hostname}`);
            try {
              this.status = await query('com.atproto.sync.getRepoStatus', {
                params: { did },
              });
            } catch(e) {
              if (relay.missingApis?.['com.atproto.sync.getRepoStatus']) {
                this.error = 'Can\'t check';
                this.expectedErrorInfo = relay.missingApis?.['com.atproto.sync.getRepoStatus'];
              } else if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to check (see console)';
                console.error(e);
              }
            }

            this.loading = false;
          },

          revStatus(repoRev) {
            if (
              !repoRev ||
              !(this.status && this.status.rev)
            ) return null;

            if (this.status.rev < repoRev) return 'behind';
            if (this.status.rev === repoRev) return 'current';
            if (this.status.rev > repoRev) return 'ahead';
          }
        }));

        Alpine.data('modLabels', did => ({
          loading: false,
          error: null,
          labels: [],

          async init() {
            this.loading = true;
            this.error = null;
            this.labels = [];

            const query = window.SimpleQuery('https://mod.bsky.app');

            try {
              const res = await query('com.atproto.label.queryLabels', {
                params: { uriPatterns: [did] },
              });
              this.labels = res.labels ?? [];
              // TODO: handle cursors?
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to check (see console)';
                console.error(e);
              }
            }
            this.loading = false;
          },
        }));

        Alpine.data('pdsHistory', (did, currentPds) => ({
          loading: false,
          error: null,
          history: [],

          async init() {
            this.loading = true;
            this.error = null;
            this.history = [];
            try {
              const res = await fetch(`https://plc.directory/${did}/log/audit`);
              if (res.ok) {
                const log = await res.json();
                let prev = null;
                for (op of log) {
                  let opPds = null;
                  const services = op.operation.services;
                  if (services) {
                    const app = services.atproto_pds;
                    if (app) {
                      opPds = app.endpoint;
                    }
                  }
                  if (opPds === prev) continue;
                  prev = opPds;
                  this.history.push({
                    pds: opPds,
                    date: op.createdAt,
                  });
                }
                this.history.reverse();
                if (this.history[0]) this.history[0].current = true;
              } else {
                this.error = `${res.status}: ${await res.text()}`;
              }
            } catch (e) {
              this.error = 'failed to get history';
              console.error(e);
            }
            this.loading = false;
          },
        }));

        Alpine.data('handleHistory', (did, currentHandle) => ({
          loading: false,
          error: null,
          history: [],

          async init() {
            this.loading = true;
            this.error = null;
            this.history = [];
            try {
              const res = await fetch(`https://plc.directory/${did}/log/audit`);
              if (res.ok) {
                const log = await res.json();
                let prev = null;
                for (op of log) {
                  let opHandle = null;
                  if (op.operation.alsoKnownAs) {
                    for (aka of op.operation.alsoKnownAs) {
                      if (aka.startsWith("at://")) {
                        opHandle = aka.slice("at://".length);
                        break;
                      }
                    }
                  }
                  if (opHandle === prev) continue;
                  prev = opHandle;
                  this.history.push({
                    handle: opHandle,
                    date: op.createdAt,
                  });
                }
                this.history.reverse();
              } else {
                this.error = `${res.status}: ${await res.text()}`;
              }
            } catch (e) {
              this.error = 'failed to get history';
              console.error(e);
            }
            this.loading = false;
          },
        }));
      })
    </script>
  </head>
  <body x-data="debug" class="bg-base-200">
    <div class="hero bg-base-200 p-8">
      <div class="hero-content flex-col">
        <h1 class="text-2xl mb-8">PDS Debugger</h1>
        <form @submit.prevent="await diagnose()">
          <label class="text-sm text-primary" for="identifier">
            atproto handle, DID, or HTTPS PDS URL
          </label>
          <br/>
          <div class="join">
            <input
              id="identifier"
              class="input join-item"
              x-model="identifier"
              :disabled="identifierLoading"
              autofocus
            />
            <button
              class="btn btn-primary join-item"
              type="submit"
            >go</button>
          </div>
        </form>
      </div>
    </div>

    <div class="w-full max-w-lg mx-auto">
      <template x-if="identifierError">
        <p>uh oh: <span x-text="identifierError"></span></p>
      </template>

      <template x-if="pds != null">

        <div class="card bg-base-100 w-full max-w-2xl shrink-0 shadow-2xl m-4">
          <div class="card-body">
            <h2 class="card-title">
               <span class="badge badge-secondary">PDS</span>
               <span x-text="pds"></span>
            </h2>

            <div
              x-data="pdsCheck(pds)"
              x-init="$watch('pds', v => update(v))"
            >
              <h3 class="text-lg mt-3">
                Server
                <span
                  x-show="description !== null"
                  class="badge badge-sm badge-soft badge-success"
                >online</span>
              </h3>
              <p x-show="loadingDesc">Loading&hellip;</p>
              <p x-show="error" class="text-warning" x-text="error"></p>
              <template x-if="description !== null">
                <div>
                  <div class="overflow-x-auto">
                    <table class="table table-xs">
                      <tbody>
                        <tr>
                          <td class="text-sm">
                            Open registration:
                            <span
                              x-text="!description.inviteCodeRequired"
                            ></span>
                          </td>
                        </tr>
                        <tr>
                          <td class="text-sm">
                            Version:
                            <code
                              class="text-xs"
                              x-text="version"
                            ></code>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <h4 class="font-bold">
                    Accounts
                  </h4>
                  <div class="overflow-x-auto overflow-y-auto max-h-26">
                    <table class="table table-xs">
                      <tbody>
                        <template x-for="account in accounts">
                          <tr>
                            <td>
                              <code>
                                <a
                                  href="#"
                                  class="link"
                                  x-text="account.did"
                                  @click.prevent="goto(account.did)"
                                ></a>
                              </code>
                            </td>
                            <td>
                              <span
                                x-show="account.active"
                                class="badge badge-sm badge-soft badge-success"
                              >
                                active
                              </span>
                              <span
                                x-show="!account.active"
                                x-text="account.status"
                                class="badge badge-sm badge-soft badge-warning"
                              ></span>
                            </td>
                            <td
                              x-data="didToHandle(account.did)"
                              x-intersect:enter.once="load"
                            >
                              <span x-show="loading">Loading&hellip;</span>
                              <span x-show="error !== null" x-text="error"></span>
                              <a
                                href="#"
                                class="link"
                                @click.prevent="goto(handle)"
                                x-show="handle !== null"
                                x-text="`@${handle}`"
                              ></a>
                            </td>
                          </tr>
                        </template>
                        <template x-if="!loadingDesc && !accountsComplete">
                          <tr>
                            <td colspan="2" class="text-xs text-warning-content">
                              (more accounts not shown)
                            </td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </template>
            </div>

            <h3 class="text-lg mt-3">Relay host status</h3>
            <div class="overflow-x-auto">
              <table class="table table-xs">
                <tbody>
                  <template x-for="relay in window.relays">
                    <tr
                      x-data="relayCheckHost(pds, relay)"
                      x-init="$watch('pds', pds => check(pds, relay))"
                    >
                      <td class="text-sm">
                        <div class="tooltip tooltip-right" :data-tip="relay.hostname">
                          <img
                            class="inline-block h-4 w-4"
                            :src="relay.icon"
                            alt=""
                          />
                          <span x-text="relay.name"></span>
                          <span
                            x-show="!!relay.note"
                            x-text="relay.note"
                            class="badge badge-soft badge-neutral badge-xs"
                          ></span>
                        </div>
                      </td>
                      <td>
                        <template x-if="loading">
                          <em>loading&hellip;</em>
                        </template>
                        <template x-if="error">
                          <div
                            class="text-xs"
                            :class="expectedErrorInfo
                              ? 'text-info tooltip tooltip-left cursor-help'
                              : 'text-warning'"
                            :data-tip="expectedErrorInfo"
                          >
                            <span x-text="error"></span>
                            <span
                              x-show="!!expectedErrorInfo"
                              class="badge badge-soft badge-info badge-xs"
                            >i</span>
                          </div>
                        </template>
                        <template x-if="status">
                          <span
                            x-text="status"
                            class="badge badge-sm"
                            :class="status === 'active' && 'badge-soft badge-success'"
                          ></span>
                        </template>
                      </td>
                      <td>
                        <div x-show="status !== 'active' && !expectedErrorInfo">
                          <button
                            x-show="reqCrawlStatus !== 'done'"
                            class="btn btn-xs btn-ghost whitespace-nowrap"
                            :disabled="reqCrawlStatus === 'loading'"
                            @click="requestCrawl(pds, relay)"
                          >
                            request crawl
                          </button>
                          <span
                            x-show="reqCrawlError !== null"
                            x-text="reqCrawlError"
                            class="text-xs text-warning"
                          ></span>
                          <button
                            x-show="reqCrawlError === null && reqCrawlStatus === 'done'"
                            class="btn btn-xs btn-soft btn-primary whitespace-nowrap"
                            @click="check"
                          >
                            refresh
                          </button>
                        </div>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </template>

      <template x-if="did != null">
        <div class="card bg-base-100 w-full max-w-2xl shrink-0 shadow-2xl m-4">
          <div class="card-body">
            <h2 class="card-title">
              <span class="badge badge-secondary">DID</span>
              <code x-text="did"></code>
            </h2>
            <template x-if="pds != null">
              <div x-data="didRepoState(did, pds)">
                <h3 class="text-lg mt-3">
                  Repo
                  <span
                    x-show="state && state.active"
                    class="badge badge-sm badge-soft badge-success"
                  >active</span>
                </h3>
                <div class="overflow-x-auto">
                  <table class="table table-xs">
                    <tbody>
                      <tr>
                        <td class="text-sm">
                          Rev:
                          <code x-text="state && state.rev"></code>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-sm">
                          Size:
                          <span x-data="repoSize">
                            <template x-if="loading">
                              <em>loading&hellip;</em>
                            </template>
                            <template x-if="error">
                              <span class="text-xs text-warning" x-text="error"></span>
                            </template>
                            <template x-if="size">
                              <code>
                                <span x-text="size"></span> MiB
                              </code>
                            </template>
                            <template x-if="!size && !error && !loading">
                              <button
                                class="btn btn-xs btn-soft btn-primary"
                                @click.prevent="loadRepoForSize(did, pds)"
                              >load</button>
                            </template>
                          </span>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-sm">
                          PDS:
                          <a
                            href="#"
                            class="link"
                            @click.prevent="goto(pds)"
                            x-text="pds"
                          ></a>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <h3 class="text-lg mt-3">
                  Relay repo status
                </h3>
                <div class="overflow-x-auto">
                  <table class="table table-xs">
                    <tbody>
                      <template x-for="relay in window.relays">
                        <tr
                          x-data="relayCheckRepo(did, relay)"
                          x-init="$watch('pds', pds => check(did, relay))"
                        >
                          <td class="text-sm">
                            <div class="tooltip tooltip-right" :data-tip="relay.hostname">
                              <img
                                class="inline-block h-4 w-4"
                                :src="relay.icon"
                                alt=""
                              />
                              <span x-text="relay.name"></span>
                              <span
                                x-show="!!relay.note"
                                x-text="relay.note"
                                class="badge badge-neutral badge-soft badge-xs"
                              ></span>
                            </div>
                          </td>
                          <template x-if="loading">
                            <td>
                              <em>loading&hellip;</em>
                            </td>
                          </template>
                          <template x-if="error">
                            <td>
                              <div
                                class="text-xs"
                                :class="expectedErrorInfo
                                  ? 'text-info tooltip tooltip-left cursor-help'
                                  : 'text-warning'"
                                :data-tip="expectedErrorInfo"
                              >
                                <span x-text="error"></span>
                                <span
                                  x-show="!!expectedErrorInfo"
                                  class="badge badge-soft badge-info badge-xs"
                                >i</span>
                              </div>
                            </td>
                          </template>
                          <template x-if="status">
                            <td>
                              <span
                                x-show="status.active"
                                class="badge badge-sm badge-soft badge-success"
                              >
                                active
                              </span>
                              <span
                                x-show="!status.active"
                                x-text="status.status"
                                class="badge badge-sm badge-soft badge-warning"
                              ></span>
                            </td>
                          </template>
                          <template x-if="revStatus(state && state.rev)">
                            <td x-data="{ asdf: revStatus(state.rev) }">
                              <span
                                x-show="asdf === 'current'"
                                class="badge badge-sm badge-soft badge-success"
                              >current</span>
                              <span
                                x-show="asdf === 'behind'"
                                class="badge badge-sm badge-soft badge-warning tooltip tooltip-left"
                                :data-tip="status.rev"
                              >behind</span>
                              <span
                                x-show="asdf === 'ahead'"
                                class="badge badge-sm badge-soft badge-success tooltip tooltip-left"
                                :data-tip="`Account may have updated between checks? ${status.rev}`"
                              >ahead</span>
                            </td>
                          </template>
                          <template x-if="!revStatus(state && state.rev)">
                            <td></td>
                          </template>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>

                <div x-data="modLabels(did)">
                  <h3 class="text-lg mt-3">
                    Labels
                  </h3>
                  <div class="overflow-x-auto">
                    <table class="table table-xs">
                      <tbody>
                        <template x-if="loading">
                          <tr>
                            <td>Loading&hellip;</td>
                          </tr>
                        </template>
                        <template x-if="error">
                          <tr>
                            <td>Error: <span x-text="error"></span></td>
                          </tr>
                        </template>
                        <template x-if="!loading && !error && labels.length === 0">
                          <tr>
                            <td class="text-sm">
                              <em>no labels applied by mod.bsky.app</em>
                            </td>
                          </tr>
                        </template>
                        <template x-for="label in labels">
                          <template x-if="!!label">
                            <tr x-data="{ expired: isBeforeNow(label.exp) }">
                              <td>
                                <span x-show="label.neg">removed</span>
                                <code
                                  x-text="label.cts.split('T')[0]"
                                  :title="label.cts"
                                ></code>
                              </td>
                              <td>
                                <template x-if="!!label.exp">
                                  <span x-text="expired ? 'expired' : 'expires'"></span>
                                  <code
                                    x-text="label.exp.split('T')[0]"
                                    :title="label.exp"
                                  ></code>
                                </template>
                              </td>
                              <td>
                                <code
                                  x-text="label.val"
                                  class="badge badge-sm badge-soft"
                                  :class="(label.neg || expired) ? 'badge-neutral line-through' : 'badge-warning'"
                                  :title="label.neg
                                    ? 'label negated'
                                    : expired
                                      ? 'label expired'
                                      : ''"
                                ></code>
                              </td>
                            </tr>
                          </template>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>

                <template x-if="did.startsWith('did:plc:')">
                  <div x-data="pdsHistory(did, pds)">
                    <h3 class="text-lg mt-3">
                      PLC PDS history
                    </h3>
                    <div class="overflow-x-auto">
                      <table class="table table-xs">
                        <tbody>
                          <template x-if="loading">
                            <tr>
                              <td>Loading&hellip;</td>
                            </tr>
                          </template>
                          <template x-if="error">
                            <tr>
                              <td>Error: <span x-text="error"></span></td>
                            </tr>
                          </template>
                          <template x-if="!loading && !error && history.length === 0">
                            <tr>
                              <td class="text-sm">
                                <em>no previous PDS</em>
                              </td>
                            </tr>
                          </template>
                          <template x-for="event in history">
                            <tr x-data="didRepoState(did, event.pds)">
                              <td>
                                <code x-text="event.date.split('T')[0]"></code>
                              </td>
                              <td>
                                <a
                                  href="#"
                                  class="link"
                                  @click.prevent="goto(event.pds)"
                                  x-text="event.pds"
                                ></a>
                              </td>
                              <template x-if="event.current">
                                <td>
                                  <span
                                    x-show="state && !state.active"
                                    x-text="state && state.status"
                                    class="badge badge-sm badge-soft badge-warning"
                                  ></span>
                                  <span
                                    x-show="state && state.active"
                                    class="badge badge-sm badge-soft badge-success"
                                  >current</span>
                                </td>
                              </template>
                              <template x-if="!event.current">
                                <td>
                                  <span
                                    x-show="state && !state.active"
                                    x-text="state && state.status"
                                    class="badge badge-sm badge-soft badge-success"
                                  ></span>
                                  <span
                                    x-show="state && state.active"
                                    class="badge badge-sm badge-soft badge-warning"
                                  >active</span>
                                </td>
                              </template>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </div>
      </template>

      <template x-if="handle !== null">
        <div class="card bg-base-100 w-full max-w-2xl shrink-0 shadow-2xl m-4">
          <div
            x-data="checkHandle(handle)"
            x-init="$watch('handle', h => updateHandle(h))"
            class="card-body"
          >
            <h2 class="card-title">
              <span class="badge badge-secondary">Handle</span>
              <span x-text="handle"></span>
            </h2>

            <h3 class="text-lg mt-3">
              Resolution
            </h3>
            <p x-show="loading" class="text-i">Loading&hellip;</p>
            <div x-show="!loading" class="overflow-x-auto">
              <table class="table table-xs">
                <tbody>
                  <tr>
                    <td class="text-sm">DNS</td>
                    <td class="text-sm">
                      <code x-text="dnsDid"></code>
                    </td>
                    <td>
                      <div
                        class="badge badge-sm badge-soft badge-neutral"
                        x-show="dnsErr !== null"
                        x-text="dnsErr"
                      ></div>
                    </td>
                  </tr>
                  <tr>
                    <td class="text-sm">Http</td>
                    <td class="text-sm">
                      <code x-text="httpDid"></code>
                    </td>
                    <td>
                      <div
                        class="badge badge-sm badge-soft badge-neutral"
                        x-show="httpErr !== null"
                        x-text="httpErr"
                      ></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <template x-if="did !== null && did.startsWith('did:plc:')">

              <div x-data="handleHistory(did, handle)">
                <h3 class="text-lg mt-3">
                  PLC handle history
                </h3>
                <div class="overflow-x-auto">
                  <table class="table table-xs">
                    <tbody>
                      <template x-if="loading">
                        <tr>
                          <td>Loading&hellip;</td>
                        </tr>
                      </template>
                      <template x-if="error">
                        <tr>
                          <td>Error: <span x-text="error"></span></td>
                        </tr>
                      </template>
                      <template x-if="!loading && !error && history.length === 0">
                        <tr>
                          <td class="text-sm">
                            <em>no previous handle</em>
                          </td>
                        </tr>
                      </template>
                      <template x-for="event in history">
                        <tr>
                          <td>
                            <code x-text="event.date.split('T')[0]"></code>
                          </td>
                          <td>
                            <a
                              href="#"
                              class="link"
                              @click.prevent="goto(event.handle)"
                              x-text="event.handle"
                            ></a>
                          </td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>

            </template>
          </div>
        </div>
      </template>
    </div>



    <div class="footer text-xs sm:footer-horizontal text-neutral mt-32 p-8 max-w-2xl mx-auto">
      <nav>
        <h3 class="footer-title">Current limitations</h3>
        <p>PDS hosts without CORS will fail tests</p>
        <p>Bluesky relay is missing API endpoints</p>
        <p>Blacksky relay is also missing API endpoints</p>
        <p>The requestCrawl button is not well tested</p>
      </nav>
      <nav>

        <h3 class="footer-title">Future features</h3>
        <p>Account label lookup</p>
      </nav>
    </div>

  </body>
</html>
