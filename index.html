<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width"/>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <script type="module">
      import {
        Client,
        ClientResponseError,
        ok,
        simpleFetchHandler,
      } from 'https://esm.sh/@atcute/client@4.1.1';
      import {
        DohJsonHandleResolver,
        WellKnownHandleResolver,
      } from 'https://esm.sh/@atcute/identity-resolver@1.2.0';

      window.SimpleQuery = service => {
        const client = new Client({ handler: simpleFetchHandler({ service }) });
        return (...args) => ok(client.get(...args));
      };
      window.SimpleProc = service => {
        const client = new Client({ handler: simpleFetchHandler({ service }) });
        return (...args) => ok(client.post(...args));
      };
      window.isXrpcErr = e => e instanceof ClientResponseError;

      window.dnsResolver = new DohJsonHandleResolver({
        dohUrl: 'https://mozilla.cloudflare-dns.com/dns-query',
      });
      window.httpResolver = new WellKnownHandleResolver();

      window.slingshot = window.SimpleQuery('https://slingshot.microcosm.blue');
      window.relays = [
        {
          name: 'Bluesky sync1.1 East',
          hostname: 'relay1.us-east.bsky.network',
        },
        {
          name: 'Bluesky sync1.1 West',
          hostname: 'relay1.us-west.bsky.network',
        },
        {
          name: 'Microcosm Montreal',
          hostname: 'relay.fire.hose.cam',
        },
        {
          name: 'Microcosm France',
          hostname: 'relay3.fr.hose.cam',
        },
        {
          name: 'Bluesky prod (old)',
          hostname: 'bsky.network',
        },
        {
          name: 'Blacksky (partial xrpc)',
          hostname: 'atproto.africa',
        },
        {
          name: 'Upcloud (no CORS)',
          hostname: 'relay.upcloud.world',
        },
      ];
    </script>

    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('debug', () => ({
          // form input
          identifier: '',

          // state
          identifierLoading: false,
          identifierError: null,

          // stuff to check
          pds: null,
          did: null,
          handle: null,

          async goto(identifier) {
            this.identifier = identifier;
            await this.diagnose();
          },

          async diagnose() {
            this.identifierLoading = true;
            this.identifierError = null;
            this.pds = null;
            this.did = null;
            this.handle = null;
            this.identifier = this.identifier.trim();
            if (this.identifier === '') {
              // do nothing
            } else if (this.identifier.startsWith('https://')) {
              this.pds = this.identifier;
            } else {
              if (this.identifier.startsWith('at://')) {
                this.identifier = this.identifier.slice('at://'.length);
              }
              if (this.identifier.startsWith('did:')) {
                this.did = this.identifier;
                let data;
                try {
                  data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                    params: { identifier: this.identifier },
                  });
                  this.pds = data.pds;
                  this.handle = data.handle;
                } catch (e) {
                  if (window.isXrpcErr(e)) {
                    this.identifierError = e.error;
                    if (e.message) this.description += ` ${e.description}`;
                  } else {
                    this.identifierError = 'Failed to resolve identifier, see console for error.';
                    console.error(e);
                  }
                }
              } else {
                this.handle = this.identifier;
                let data;
                try {
                  data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                    params: { identifier: this.identifier },
                  });
                  this.did = data.did;
                  this.pds = data.pds;
                } catch (e) {
                  if (window.isXrpcErr(e)) {
                    this.identifierError = e.error;
                    if (e.message) this.description += ` ${e.description}`;
                  } else {
                    this.identifierError = 'Failed to resolve identifier, see console for error.';
                    console.error(e);
                  }
                }
              }
            }
            this.identifierLoading = false;
          },
        }));

        Alpine.data('pdsCheck', pds => ({
          loadingDesc: false,
          error: null,
          description: null,
          accounts: [],
          accountsComplete: false,
          version: null,

          async init() {
            await this.update(pds);
          },

          async update(pds) {
            this.loadingDesc = true;
            this.error = null;
            this.description = null;
            this.accounts = [];
            this.accountsComplete = false;
            this.version = null;

            if (!pds) {
              this.loadingDesc = false;
              return;
            }

            let query = window.SimpleQuery(pds);
            try {
              this.description = await query('com.atproto.server.describeServer');
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            let health
            try {
              health = await query('_health');
              this.version = health.version;
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            let accountsRes;
            try {
              accountsRes = await query('com.atproto.sync.listRepos', {
                params: { limit: 100 },
              });
              this.accounts = accountsRes.repos;
              this.accountsComplete == !accountsRes.cursor;
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to reach (see console)';
                console.error(e);
              }
            }
            this.loadingDesc = false;
          },
        }));

        Alpine.data('relayCheckHost', (pds, relay) => ({
          loading: false,
          error: null,
          status: null,
          reqCrawlStatus: null,
          reqCrawlError: null,

          async init() {
            await this.check(pds, relay);
          },

          async check(pds, relay) {
            this.loading = true;
            this.error = null;
            this.status = null;
            const query = window.SimpleQuery(`https://${relay.hostname}`);
            const hostname = pds.split('://')[1];
            let data;
            try {
              data = await query('com.atproto.sync.getHostStatus', {
                params: { hostname },
              });
              this.status = data.status;
            } catch(e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to check (see console)';
                console.error(e);
              }
            }
            this.loading = false;
            this.reqCrawlStatus = null;
            this.reqCrawlError = null;
          },

          async requestCrawl(pds, relay) {
            this.reqCrawlStatus = "loading";
            const proc = window.SimpleProc(`https://${relay.hostname}`);
            const hostname = pds.split('://')[1];
            let data;
            try {
              data = await proc('com.atproto.sync.requestCrawl', {
                input: { hostname },
              });
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.reqCrawlError = e.error;
              } else {
                this.reqCrawlError = 'failed (see console)';
                console.error(e);
              }
            }
            this.reqCrawlStatus = "done";
          },
        }));

        Alpine.data('checkHandle', handle => ({
          loading: false,
          dnsDid: null,
          dnsErr: null,
          httpDid: null,
          httpErr: null,

          async init() {
            await this.updateHandle(handle);
          },
          async updateHandle(handle) {
            this.loading = true;
            this.dnsDid = null;
            this.dnsErr = null;
            this.httpDid = null;
            this.httpErr = null;
            try {
              this.dnsDid = await window.dnsResolver.resolve(handle);
            } catch (e) {
              this.dnsErr = e.name;
            }
            try {
              this.httpDid = await window.httpResolver.resolve(handle);
            } catch (e) {
              this.httpErr = e.name;
            }
            this.loading = false;
          },
        }));

        Alpine.data('didToHandle', did => ({
          loading: false,
          error: null,
          handle: null,
          async load() {
            loading = true;
            error = null;
            handle = null;
            let data;
            try {
              data = await window.slingshot('com.bad-example.identity.resolveMiniDoc', {
                params: { identifier: did },
              });
              this.handle = data.handle;
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'failed (see console)';
                console.error(e);
              }
            }
            loading = false;
          }
        }));

        Alpine.data('didRepoState', (did, pds) => ({
          loading: false,
          error: null,
          state: null,

          async init() {
            await this.checkRepoState(did, pds);
          },
          async checkRepoState(did, pds) {
            this.loading = true;
            this.error = null;
            this.state = null;

            if (!did || !pds) {
              this.loading = false;
              return;
            }
            const query = window.SimpleQuery(pds);
            try {
              this.state = await query('com.atproto.sync.getRepoStatus', {
                params: { did },
              });
            } catch (e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'failed (see console)';
                console.error(e);
              }
            }
            this.loading = false;
          },
        }));

        Alpine.data('relayCheckRepo', (did, relay) => ({
          loading: false,
          error: null,
          status: null,

          async init() {
            await this.check(did, relay);
          },

          async check(did, relay) {
            this.loading = true;
            this.error = null;
            this.status = null;

            const query = window.SimpleQuery(`https://${relay.hostname}`);
            try {
              this.status = await query('com.atproto.sync.getRepoStatus', {
                params: { did },
              });
            } catch(e) {
              if (window.isXrpcErr(e)) {
                this.error = e.error;
              } else {
                this.error = 'Failed to check (see console)';
                console.error(e);
              }
            }

            this.loading = false;
          },
        }));
      })
    </script>
  </head>
  <body x-data="debug">
    <div class="hero bg-base-200">
      <div class="hero-content flex-col">
        <h1>PDS Debugger</h1>

        <p>Work in progress!</p>
        <details class="text-xs">
          <summary>Would be nice</summary>
          <ul>
            <li>anything that actually works</li>
            <li>firehose listener for missing pds events</li>
            <li>jetstream listener for missing pds events</li>
            <li>check relays for account status</li>
            <li>check relays for pds state</li>
            <li>plc: check old pds hosts for active account state</li>
          </ul>
        </details>
        <details class="text-xs">
          <summary>Limitations</summary>
          <ul>
            <li>it's all client-side</li>
          </ul>
        </details>

        <div class="card bg-base-100 w-full max-w-sm shrink-0 shadow-2xl">
          <div class="card-body">
            <form @submit.prevent="await diagnose()">
              <label>
                Enter an atproto handle, DID, or HTTPS PDS URL
                <input
                  class="input"
                  x-model="identifier"
                  :disabled="identifierLoading"
                  autofocus
                />
              </label>
            </form>
          </div>
        </div>

        <template x-if="identifierError">
          <p>uh oh: <span x-text="identifierError"></span></p>
        </template>

        <template x-if="pds != null">
          <div class="card bg-base-100 w-full max-w-lg shrink-0 shadow-2xl">
            <div class="card-body">
              <h2 class="card-title">
                 <span class="badge badge-secondary">PDS</span>
                 <span x-text="pds"></span>
              </h2>

              <div
                x-data="pdsCheck(pds)"
                x-init="$watch('pds', v => update(v))"
              >
                <h3 class="text-lg">
                  Server
                  <span
                    x-show="description !== null"
                    class="badge badge-sm badge-soft badge-success"
                  >online</span>
                </h3>
                <p x-show="loadingDesc">Loading&hellip;</p>
                <p x-show="error" class="text-warning" x-text="error"></p>
                <template x-if="description !== null">
                  <div>
                    <div class="overflow-x-auto">
                      <table class="table table-xs">
                        <tbody>
                          <tr>
                            <td class="text-sm">
                              Open registration:
                              <span
                                x-text="!description.inviteCodeRequired"
                              ></span>
                            </td>
                          </tr>
                          <tr>
                            <td class="text-sm">
                              Version:
                              <code
                                class="text-xs"
                                x-text="version"
                              ></code>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <h4 class="font-bold">
                      Accounts
                    </h4>
                    <div class="overflow-x-auto overflow-y-auto max-h-26">
                      <table class="table table-xs">
                        <tbody>
                          <template x-for="account in accounts">
                            <tr>
                              <td>
                                <code>
                                  <a
                                    href="#"
                                    class="link"
                                    x-text="account.did"
                                    @click.prevent="goto(account.did)"
                                  ></a>
                                </code>
                              </td>
                              <td>
                                <span
                                  x-show="account.active"
                                  class="badge badge-sm badge-soft badge-success"
                                >
                                  active
                                </span>
                                <span
                                  x-show="!account.active"
                                  x-text="account.status"
                                  class="badge badge-sm badge-soft badge-warning"
                                ></span>
                              </td>
                              <td
                                x-data="didToHandle(account.did)"
                                x-intersect:enter.once="load"
                              >
                                <span x-show="loading">Loading&hellip;</span>
                                <span x-show="error !== null" x-text="error"></span>
                                <a
                                  href="#"
                                  class="link"
                                  @click.prevent="goto(handle)"
                                  x-show="handle !== null"
                                  x-text="`@${handle}`"
                                ></a>
                              </td>
                            </tr>
                          </template>
                          <template x-if="!loadingDesc && !accountsComplete">
                            <tr>
                              <td colspan="2" class="text-xs text-warning-content">
                                (more accounts not shown)
                              </td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </template>
              </div>

              <h3 class="text-lg">Relay host status</h3>
              <div class="overflow-x-auto overflow-y-auto max-h-33">
                <table class="table table-xs">
                  <tbody>
                    <template x-for="relay in window.relays">
                      <tr
                        x-data="relayCheckHost(pds, relay)"
                        x-init="$watch('pds', pds => check(pds, relay))"
                      >
                        <td x-text="relay.name" class="text-sm"></td>
                        <td>
                          <template x-if="loading">
                            <em>loading&hellip;</em>
                          </template>
                          <template x-if="error">
                            <span
                              x-text="error"
                              class="text-xs text-warning"
                            ></span>
                          </template>
                          <template x-if="status">
                            <span
                              x-text="status"
                              class="badge badge-sm"
                              :class="status === 'active' && 'badge-soft badge-success'"
                            ></span>
                          </template>
                        </td>
                        <td>
                          <div x-show="status !== 'active'">
                            <button
                              x-show="reqCrawlStatus !== 'done'"
                              class="btn btn-xs btn-ghost whitespace-nowrap"
                              :disabled="reqCrawlStatus === 'loading'"
                              @click="requestCrawl(pds, relay)"
                            >
                              request crawl
                            </button>
                            <span
                              x-show="reqCrawlError !== null"
                              x-text="reqCrawlError"
                              class="text-xs text-warning"
                            ></span>
                            <button
                              x-show="reqCrawlError === null && reqCrawlStatus === 'done'"
                              class="btn btn-xs btn-soft btn-primary whitespace-nowrap"
                              @click="check"
                            >
                              refresh
                            </button>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </template>

        <template x-if="did != null">
          <div class="card bg-base-100 w-full max-w-lg shrink-0 shadow-2xl">
            <div class="card-body">
              <h2 class="card-title">
                <span class="badge badge-secondary">DID</span>
                <code x-text="did"></code>
              </h2>
              <template x-if="pds != null">
                <div x-data="didRepoState(did, pds)">
                  <h3 class="text-lg">
                    Repo
                    <span
                      x-show="state && state.active"
                      class="badge badge-sm badge-soft badge-success"
                    >active</span>
                  </h3>
                  <div class="overflow-x-auto">
                    <table class="table table-xs">
                      <tbody>
                        <tr>
                          <td class="text-sm">
                            Rev:
                            <code x-text="state && state.rev"></code>
                          </td>
                        </tr>
                        <tr>
                          <td class="text-sm">
                            PDS:
                            <a
                              href="#"
                              class="link"
                              @click.prevent="goto(pds)"
                              x-text="pds"
                            ></a>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <h3 class="text-lg">
                    Relay repo status
                  </h3>
                  <div class="overflow-x-auto overflow-y-auto max-h-33">
                    <table class="table table-xs">
                      <tbody>
                        <template x-for="relay in window.relays">
                          <tr
                            x-data="relayCheckRepo(did, relay)"
                            x-init="$watch('pds', pds => check(did, relay))"
                          >
                            <td x-text="relay.name" class="text-sm"></td>
                            <template x-if="loading">
                              <td>
                                <em>loading&hellip;</em>
                              </td>
                            </template>
                            <template x-if="error">
                              <td
                                x-text="error"
                                class="text-xs text-warning"
                              ></td>
                            </template>
                            <template x-if="status">
                              <td>
                                <span
                                  x-show="status.active"
                                  class="badge badge-sm badge-soft badge-success"
                                >
                                  active
                                </span>
                                <span
                                  x-show="!status.active"
                                  x-text="status.status"
                                  class="badge badge-sm badge-soft badge-warning"
                                ></span>
                              </td>
                            </template>
                            <template x-if="status">
                              <td>
                                <code
                                  x-text="status.rev"
                                  class="badge badge-sm badge-soft"
                                  :class="status && state && (status.rev >= state.rev) ? 'badge-success' : 'badge-warning'"
                                ></code>
                              </td>
                            </template>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>

        <template x-if="handle != null">
          <div class="card bg-base-100 w-full max-w-lg shrink-0 shadow-2xl">
            <div
              x-data="checkHandle(handle)"
              x-init="$watch('handle', h => updateHandle(h))"
              class="card-body"
            >
              <h2 class="card-title">
                <span class="badge badge-secondary">Handle</span>
                <span x-text="handle"></span>
              </h2>
              <p x-show="loading" class="text-i">Loading&hellip;</p>
              <div x-show="!loading" class="overflow-x-auto">
                <table class="table table-xs">
                  <tbody>
                    <tr>
                      <td class="text-sm">DNS</td>
                      <td class="text-sm">
                        <code x-text="dnsDid"></code>
                      </td>
                      <td>
                        <div
                          class="badge badge-sm badge-soft badge-neutral"
                          x-show="dnsErr !== null"
                          x-text="dnsErr"
                        ></div>
                      </td>
                    </tr>
                    <tr>
                      <td class="text-sm">Http</td>
                      <td class="text-sm">
                        <code x-text="httpDid"></code>
                      </td>
                      <td>
                        <div
                          class="badge badge-sm badge-soft badge-neutral"
                          x-show="httpErr !== null"
                          x-text="httpErr"
                        ></div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </body>
</html>
